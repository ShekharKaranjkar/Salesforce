<apex:page docType="html-5.0"  showHeader="false" sidebar="false" applyBodyTag="false" applyHtmlTag="false" cache="true" expires="50" controller="DriverMenuCtrl" language="{!userLanguage}">
    <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" lang="en">
    
        <META HTTP-EQUIV="Content-type" CONTENT="text/html; charset=UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"/>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
        <script src="https://www.google.com/recaptcha/api.js"></script>
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"/>
        <apex:includeScript value="https://code.jquery.com/jquery-1.11.3.js"/>
    <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
        <script src="../../soap/ajax/47.0/connection.js"
          type="text/javascript"></script>
        <apex:slds />
        <style>
        .slds-scope .slds-notify_toast{
             min-width: 0rem;
        }
        </style>
        <script>
        var domain = "{!$Label.Driver_Menu_Domain}";
        if(!window.location.href.includes(domain))
            domain = '/apex';
        var userAgent = navigator.userAgent;
        var theme = '{!$User.UITheme}';
        var RecordtypeName = '{!$CurrentPage.parameters.reason}';
        var foundtheme;
             if (theme === 'Theme4d' || theme === 'Theme4u'){
                foundtheme = 'Lightning';
            } 
            else if(theme ==='Theme4t'){
            if(userAgent.includes("SalesforceMoblieSDK") || userAgent.includes("Salesforce1"))
                foundtheme = 'Mobile App';
                else
               foundtheme = 'Mobile Browser';
                     }             
            else {
                foundtheme = 'Non Lightning';
            }
        function createrecord(){
            debugger;
            var issuewith = '{!issuewith}';
            var inputfileids = $('[id$=fileidhidden]').val();
            var latitude =  document.getElementById('lat').value;
            var longitude = document.getElementById('long').value;
            if(latitude.length == 0 || latitude == undefined || longitude.length == 0 || longitude == undefined){
            showtoast('Location_Not_Found_Toast');
                        setTimeout(function(){ hidetoast('Location_Not_Found_Toast'); }, 1000);
            }else{
            var objectname = 'ServiceRequest';
            var serviceprovider = '{!VehicleAssignment.Service_Provider__c}';
            var vehicleassignid = '{!VehicleAssignment.Id}';
            var vehicle = '{!VehicleAssignment.Vehicle__c}';
            var request = {'issuewith': issuewith,'inputfileids':inputfileids,'latitude':latitude,'longitude':longitude,'requesttype':'Vehicle Towing','reason':'Towing Request',
                           'RecordtypeName':RecordtypeName,'objectname':objectname,'serviceprovider':serviceprovider,'vehicle':vehicle,'vehicleassignid':vehicleassignid,};
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.DriverMenuCtrl.createisseus}',
                request,
                function(result, event) {
                    console.log(result);
                    if(event.type === 'exception') {
                        showtoast('Error_Toast');
                        console.log("exception");
                        console.log(event);
                    } else if(event.status) {
                       showtoast('Success_Toast');
                        setTimeout(function(){ gotodrivermenu(); }, 1000);
                    } else {
                        console.log(event.message);
                        showtoast('Error_Toast');
                    }
                },
                {buffer: true, escape: true, timeout: 120000}
            );
                }
        }
        function gotodrivermenu(){
            var theme = '{!$User.UITheme}';
            if (theme === 'Theme4d' || theme === 'Theme4u'){
                sforce.one.navigateToURL(domain+'/apex/DriverMenu');
            } 
            else if(theme ==='Theme4t'){
            if(userAgent.includes("SalesforceMoblieSDK") || userAgent.includes("Salesforce1"))
                sforce.one.navigateToURL(domain+'/DriverMenu');
                else
               window.location=domain+'/DriverMenu';
                     }             
            else {
                window.location=domain+'/DriverMenu';
            }
        }
        function filespill(result,name){
            //debugger;
            $('[id*=spinner1]').hide();
            $("#filenames1").append("<span class=\"slds-pill slds-pill_link\" id=\""+result+"\"><a href=\"javascript:deletefiles('"+result+"');\" class=\"slds-pill__action\" title=\"Full pill label verbiage mirrored here\"><span class=\"slds-pill__label\">"+name+"</span></a><button class=\"slds-button slds-button_icon slds-button_icon slds-pill__remove\" title=\"Remove\" onclick=\"return deletefiles('"+result+"')\"><svg class=\"slds-button__icon\" aria-hidden=\"true\" ><use xlink:href=\"{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#close')}\"></use></svg><span class=\"slds-assistive-text\">Remove</span></button></span>");
            var fileids = $('[id$=fileidhidden]').val();
            if(fileids.length > 1){
                fileids = fileids +','+ result;}
            else {
                fileids = result;}  
            $('[id$=fileidhidden]').val(fileids);
            //$('[id$=propertyhidden]').val(result);
        }
        function deletefiles(recordid){
            //alert(recordid);
            $('[id$='+recordid+']').hide();
            var str = $('[id$=fileidhidden]').val();
            str = str.replace(recordid, "");
            $('[id$=fileidhidden]').val(str);
            delcontentfiles(recordid);
            return false;
        }
        function showtoast(toastid){
            $('[id$='+toastid+']').show();
        }
        function hidetoast(toastid){
            $('[id$='+toastid+']').hide();
        }
        </script>
        <script type='text/javascript'>
            var fileLenght=0; 
            var FileUploading = 0;           
            var FileUploaded = 0;           
            var ids = new Array();
            function uploaddocuments(){
                // debugger;
                $('[id*=spinner1]').show();
                var v=document.getElementById('Details_File');               
                console.log(v.files.length);              
                fileLenght = v.files.length;              
                for (var i = 0; i < v.files.length; i++) {             
                    uploadSelectedFile(v.files[i], function(err, res){          
                        FileUploading += 1;                  
                        if (FileUploading === FileUploaded){ 
                            //alert('upload completed');     
                            //blank input file value                   
                            document.getElementById('Details_File').value = "";          
                        }                
                    })               
                } 
            }
            var uploadSelectedFile = function(file, callback) {  
                //alert(where);
                filetoBase64(file, function(err, content){  
                    // alert('Content');
                    var conVer_object = {                  
                        //ContentLocation : 'S',                     
                        VersionData : content,                     
                        PathOnClient : file.name,                     
                        Title : file.name ,
                        FirstPublishLocationId  : '{!VehicleAssignment.Id}',
                        NetworkId : '{!networkid}'                  
                    };                  
                    $.ajax({ 
                        
                        url: '{!$Label.Community_user_file_upload_redirect_url}',                    
                        data: JSON.stringify(conVer_object ),                
                        type: 'POST',                 
                        processData: false,                    
                        contentType: false,                    
                        headers: {'Authorization': 'Bearer {!$Api.Session_ID}', 'Content-Type': 'application/json'},                
                        xhr: function(){                   
                            var xhr = new window.XMLHttpRequest();                       //Upload progress                      
                            xhr.upload.addEventListener("progress", function(evt){                     
                                if (evt.lengthComputable) {  
                                    $('[id*=spinner1]').hide();
                                    $('#progress_bar_container').css('display', 'block');                    
                                    var percentComplete = evt.loaded / evt.total;                      
                                    console.log('percentComplete '+percentComplete );                     
                                    var percentCompletex= percentComplete*100;                          
                                    $('#percentText').html("Uploading. Please wait... "+Math.round(percentCompletex)+"%");      
                                    $('.progress').css('width', percentCompletex+ "%");                         
                                    if(percentCompletex == 100){                           
                                        $('#progress_bar_container').css('display', 'none');                       
                                    }                      }                     }, false);                     
                            return xhr;                    },                  
                        success: function(response) { 
                            // alert('Success');
                            FileUploaded += 1;                     
                            console.log(response.id); 
                            filespill(response.id,file.name)
                            // the id of the attachment                     
                            ids.push(response.id);                      
                            console.log('Ids: ' +ids);                      
                            $('#records').html('File has been uploeded. Uploaded File ids: ' +ids);                      
                            if(fileLenght == FileUploaded ){                      
                                //calculateLocation(ids.toString());        
                            }                   
                            callback(null, true)                  
                        },
                        error : function(response) {
                            showtoast('UnableError_Toast');
                            //alert("Failed" + '{!$Label.Error_found_please_contact_system_admin}');
                            console.log('response:'+response.message)
                        },
                    });                
                });              
            }  
            var filetoBase64 = function(file, callback){ 
                //debugger;
                var reader = new FileReader();                 
                reader.onload = function() {                 
                    var myFileContents = reader.result;                  
                    var base64Mark = 'base64,';                  
                    var dataStart = myFileContents.indexOf(base64Mark) + base64Mark.length;       
                    myFileContents = myFileContents.substring(dataStart);               
                    callback(null, myFileContents);  
                    //alert('alert');
                }              
                reader.readAsDataURL(file);              
            }
            </script>
        <div class="slds-scope">
            <div class="demo-only" style="height:4rem; display:none;" id="Success_Toast">
                <div class="slds-notify_container slds-is-fixed">
                    <div class="slds-notify slds-notify_toast slds-theme_success" role="status">
                        <span class="slds-assistive-text">success</span>
                        <span class="slds-icon_container slds-icon-utility-success slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                            <svg class="slds-icon slds-icon_small" aria-hidden="true">
                                <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#success')}"></use>
                            </svg>
                        </span>
                        <div class="slds-notify__content">
                            <h2 class="slds-text-heading_small ">{!$Label.Issue_Created_successfully}</h2>
                        </div>
                        <div class="slds-notify__close">
                            <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onclick="hidetoast('Success_Toast');return false;">
                                <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                    <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#close')}"></use>
                                </svg>
                                <span class="slds-assistive-text">Close</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="demo-only" style="height:4rem; display:none;" id="Error_Toast">
                <div class="slds-notify_container slds-is-fixed">
                    <div class="slds-notify slds-notify_toast slds-theme_error" role="status">
                        <span class="slds-assistive-text">error</span>
                        <span class="slds-icon_container slds-icon-utility-error slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                            <svg class="slds-icon slds-icon_small" aria-hidden="true">
                                <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#error')}"></use>
                            </svg>
                        </span>
                        <div class="slds-notify__content">
                            <h2 class="slds-text-heading_small ">{!$Label.Unable_to_creating_issue_please_contact_admin}</h2>
                        </div>
                        <div class="slds-notify__close">
                            <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onclick="hidetoast('Error_Toast');return false;">
                                <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                    <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#close')}"></use>
                                </svg>
                                <span class="slds-assistive-text">Close</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="demo-only" style="height:4rem; display:none;" id="UnableError_Toast">
                <div class="slds-notify_container slds-is-fixed">
                    <div class="slds-notify slds-notify_toast slds-theme_error" role="status">
                        <span class="slds-assistive-text">error</span>
                        <span class="slds-icon_container slds-icon-utility-error slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                            <svg class="slds-icon slds-icon_small" aria-hidden="true">
                                <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#error')}"></use>
                            </svg>
                        </span>
                        <div class="slds-notify__content">
                            <h2 class="slds-text-heading_small ">{!$Label.Error_found_please_contact_system_admin}</h2>
                        </div>
                        <div class="slds-notify__close">
                            <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onclick="hidetoast('UnableError_Toast');return false;">
                                <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                    <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#close')}"></use>
                                </svg>
                                <span class="slds-assistive-text">Close</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="demo-only" style="height:4rem; display:none;" id="Location_Not_Found_Toast">
                <div class="slds-notify_container slds-is-fixed">
                    <div class="slds-notify slds-notify_toast slds-theme_error" role="status">
                        <span class="slds-assistive-text">error</span>
                        <span class="slds-icon_container slds-icon-utility-error slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                            <svg class="slds-icon slds-icon_small" aria-hidden="true">
                                <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#error')}"></use>
                            </svg>
                        </span>
                        <div class="slds-notify__content">
                            <h2 class="slds-text-heading_small ">{!$Label.Location_Not_Found}</h2>
                        </div>
                        <div class="slds-notify__close">
                            <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onclick="hidetoast('Location_Not_Found_Toast');return false;">
                                <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                    <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#close')}"></use>
                                </svg>
                                <span class="slds-assistive-text">Close</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <apex:outputPanel style="display:block;" id="Driver_Breakdown_Towing_Form">
                <div class="slds-clearfix slds-m-bottom_small slds-page-header">
                    <div class="slds-media">
                        <div class="slds-media__figure">
                            <span class="slds-icon_container" >
                                <svg aria-hidden="true" class="slds-icon slds-icon_large" style="background-color: #3abeb1;">
                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" 
                                         xlink:href="/apexpages/slds/latest/assets/icons/utility-sprite/svg/symbols.svg#replace">
                                    </use>
                                </svg>
                                <span class="slds-assistive-text">edit_form</span>
                            </span>
                        </div>
                        <div class="slds-media__body">
                            <h1 class="slds-page-header__title slds-truncate slds-align-middle" title="Driver-Towing-Form" style="color: #54698d;font-size: 1.5rem;">{!$Label.Driver_Towing_Form}</h1>
                        </div>
                    </div>
                </div>
                <br/>
                <apex:form >
                    <div class="slds-form slds-box">
                        <div class="slds-form-element slds-form-element_edit slds-form-element_readonly slds-form-element_stacked slds-hint-parent">
                            <span class="slds-form-element__label">{!$Label.Service}</span>
                            <div class="slds-form-element__control">
                                <div class="slds-form-element__static">{!$Label.Vehicle_Towing}</div>
                            </div>
                        </div><br/>
                        <div class="slds-form-element slds-form-element_edit slds-form-element_readonly slds-form-element_stacked slds-hint-parent">
                            <span class="slds-form-element__label">{!$Label.Vehicle}</span>
                            <div class="slds-form-element__control">
                                <div class="slds-form-element__static">{!VehicleNumber}</div>
                            </div>
                        </div><br/>
                        <div class="slds-form-element slds-form-element_edit slds-form-element_readonly slds-form-element_stacked slds-hint-parent">
                            <span class="slds-form-element__label">{!$Label.Driver}</span>
                            <div class="slds-form-element__control">
                                <div class="slds-form-element__static">{!DriverName}</div>
                            </div>
                        </div>
                         <!--<div class="slds-form-element slds-form-element_edit slds-form-element_readonly slds-form-element_stacked slds-hint-parent">
                            <span class="slds-form-element__label">Location</span>
                            <div class="slds-form-element__control">
                                <div class="slds-form-element__static">Bengaluru</div>
                                <apex:map width="400px" height="200px" mapType="roadmap" zoomLevel="14" center="{latitude:{!latitudeval},longitude:{!longitudeval}}">
                                    <apex:mapMarker title="Location" position="{latitude:{!latitudeval},longitude:{!longitudeval}}"/>
                                </apex:map>
                            </div>
                        </div>-->
                        <br/>
                        <div class="slds-form-element">
                            <span class="slds-form-element__label" id="Details_File_Label">{!$Label.Upload_Image_and_Audio}</span>
                            <div class="slds-form-element__control">
                                <div class="slds-file-selector slds-file-selector_files ">
                                    <div class="slds-file-selector__dropzone">
                                        <input type="file" class="slds-file-selector__input slds-assistive-text" id="Details_File" aria-labelledby="Details_File_Label Details_File_Label2" onchange="uploaddocuments();return false;" capture="camera" accept="image/*"/>
                                        <!--<input type="file" accept="image/*;capture=camera"/>
                                        <input type="file" accept="video/*;capture=camcorder"/>
                                        <input type="file" accept="audio/*;capture=microphone"/>-->
                                        <label class="slds-file-selector__body" for="Details_File" id="Details_File_Label2">
                                            <span class="slds-file-selector__button slds-button slds-button_neutral">
                                                <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                                                    <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#upload')}"></use>
                                                </svg>{!$Label.Upload_Files}</span>
                                            <span class="slds-file-selector__text slds-medium-show">{!$Label.or_drop_Files}</span>
                                        </label>
                                        <div class="spinner-border text-primary" role="status" id="spinner1" style="display:none;">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        <div  id="filenames1"/>
                                    </div>
                                </div>
                                <br/>
                                <div id="progress_bar_container" style="display:none; padding:10px; width: 50%;">                
                                    <span id="percentText"></span>                  
                                    <div class="slds-progress-bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="25" role="progressbar"> 
                                        <span class="slds-progress-bar__value progress" style=" width: 0%;">                    
                                            <span class="slds-assistive-text">Progress: 25%</span>                     
                                        </span>                  
                                    </div>                 
                                </div>
                            </div>
                        </div>
                      <!--  <input type="file" accept="image/*" capture="camera"/>
    <input type="file" accept="image/*;capture=camera"/>
    <input type="file" capture="camera"/>
    <input type="file" accept="image/*" capture=""/>
<input type="file" accept="image/*" capture="user"/>
<input type="file" accept="image/*" capture="environment"/>-->
                        <br/>
                        <br/><c:GoogleMaps1 /><br/>
                        <div class="slds-align_absolute-center">
                            <button class="slds-button slds-button_success" onclick="createrecord();return false;">{!$Label.Save}</button><span style="width: 40px;"></span>
                        <button class="slds-button slds-button_destructive" onclick="gotodrivermenu();">{!$Label.Cancel}</button>
                        </div></div>
                </apex:form>
            </apex:outputPanel>
        </div>
    </html>
</apex:page>